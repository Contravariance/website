{"version":3,"file":"shikwasa.chapter.min.js","sources":["../src/templates/Chapter.js","../src/utils.js","../src/chapter.js"],"sourcesContent":["const chapterTemplate = /* template */`\n  <div class=\"shk-chapter_main\">\n    <ol class=\"shk-chapter_list\"></ol>\n  </div>\n  <button class=\"shk-btn shk-btn_close\" aria-label=\"close chapter panel\" title=\"close chapter panel\">\n    <svg class=\"shk-icon_close\" aria-hidden=\"true\">\n      <use xlink:href=\"#shk-icon_close\" />\n    </svg>\n  </button>\n`\n\nexport default chapterTemplate\n","import { DEFAULT ,CONFIG } from './config'\n\nexport function secondToTime(time) {\n  time = Math.round(time)\n  let hour = Math.floor(time / 3600)\n  let min = Math.floor((time - hour * 3600) / 60)\n  let sec = Math.floor(time - hour * 3600 - min * 60)\n  min = min < 10 ? '0' + min : min\n  sec = sec < 10 ? '0' + sec : sec\n  if (hour === 0) {\n    return `${min}:${sec}`\n  }\n  hour = hour < 10 ? '0' + hour : hour\n  return `${hour}:${min}:${sec}`\n}\n\nexport function numToString(num) {\n  const float = parseFloat(num).toFixed(2)\n  return float.slice(-1) === '0' ? float.slice(0, -1) :float\n}\n\nexport function marquee(textWrap, textEl, speed = 60) {\n  const overflow = textEl.offsetWidth - textWrap.offsetWidth\n  if (overflow > 0) {\n    textWrap.setAttribute('data-overflow', '')\n    const duration = textEl.offsetWidth / speed\n    textWrap.style.animationDuration = `${duration}s`\n  } else {\n    textWrap.removeAttribute('data-overflow')\n  }\n}\n\nexport function handleOptions(options) {\n  const _options = Object.assign({}, options)\n  _options.audio = Object.assign({}, options.audio)\n  Object.keys(DEFAULT).forEach(k => {\n    _options[k] = (_options[k] || typeof _options[k] === 'boolean') ?\n      _options[k] : DEFAULT[k]\n  })\n  if (typeof _options.container === 'function') {\n    _options.container = _options.container()\n  }\n  const fixedType = CONFIG.fixedOptions.find(item => item === _options.fixed.type)\n  if (!fixedType) {\n    _options.fixed.type = DEFAULT.fixed.type\n  }\n  if (!Array.isArray(_options.speedOptions)) {\n    _options.speedOptions = [_options.speedOptions]\n  }\n  if (_options.speedOptions.indexOf(1) === -1) {\n    _options.speedOptions.push(1)\n  }\n  _options.speedOptions = _options.speedOptions\n    .map(sp => parseFloat(sp))\n    .filter(sp => !isNaN(sp))\n  if (_options.speedOptions.length > 1) {\n    _options.speedOptions.sort((a, b) => a - b)\n  }\n  return _options\n}\n\nexport function handleAudio(audio = {}, parsedData = {}) {\n  let audioData = Object.assign({}, audio)\n  Object.keys(CONFIG.audioOptions).forEach(k => {\n    audioData[k] = audioData[k] ||\n      parsedData[k] ||\n      CONFIG.audioOptions[k]\n  })\n  return audioData\n}\n\nexport async function parseAudio(audio = {}, parser = {}) {\n  const { tags } = await parserWrap(audio.src, parser) || {}\n  const tagData = handleParsedTags(tags)\n  return handleAudio(audio, tagData)\n}\n\nexport function parserWrap(src, parser) {\n  return new Promise((resolve, reject) => {\n    parser.read(src, {\n      onSuccess: resolve,\n      onError: reject,\n    })\n  })\n}\n\nexport function handleParsedTags(tags = {}) {\n  let cover, chapters, duration\n  const { title, artist } = tags\n  if (tags.picture && tags.picture.data && tags.picture.format) {\n    const byteArray = new Uint8Array(tags.picture.data)\n    const blob = new Blob([byteArray], { type: tags.picture.format })\n    cover = URL.createObjectURL(blob)\n  }\n  if (tags.TLEN && tags.TLEN.data) {\n    duration = +tags.TLEN.data / 1000\n  }\n  if (tags.CHAP && tags.CHAP.length) {\n    chapters = tags.CHAP\n      .filter(ch => ch.id === 'CHAP')\n      .map(ch => {\n        if (ch.data && ch.data.subFrames && ch.data.subFrames.TIT2) {\n          return {\n            id: ch.data.id,\n            startTime: ch.data.startTime / 1000,\n            endTime: ch.data.endTime / 1000,\n            title: ch.data.subFrames.TIT2.data,\n          }\n        }\n        return false\n      })\n      .sort((a, b) => a.id - b.id)\n  }\n  return { title, artist, cover, duration, chapters }\n}\n\nexport function createElement(options) {\n  options.tag = options.tag || 'div'\n  const el = document.createElement(options.tag)\n  if (options.className) {\n    if (typeof options.className === 'string') {\n      el.classList.add(options.className)\n    } else {\n      options.className.forEach(className => {\n        el.classList.add(className)\n      })\n    }\n  }\n  if (options.attrs) {\n    Object.keys(options.attrs).forEach(key => {\n      el.setAttribute(key, options.attrs[key])\n    })\n  }\n  if (options.innerHTML) {\n    el.innerHTML = options.innerHTML\n  }\n  return el\n}\n\nexport function toggleAttribute(el, name) {\n  if (typeof el.toggleAttribute === 'function') {\n    el.toggleAttribute(name)\n    return\n  }\n  if (el.hasAttribute(name)) {\n    el.removeAttribute(name)\n  } else {\n    el.setAttribute(name, '')\n  }\n}\n\nexport function animateScroll(\n  timestamp,\n  startTime,\n  duration,\n  startPos,\n  distance,\n  scrollEl) {\n  const elapsed = (timestamp - startTime) / 1000\n  const t = elapsed / duration\n\n  // easing in a linear fashion\n  scrollEl.scrollTop = startPos + distance * t\n  if (t < 1) {\n    window.requestAnimationFrame(ts => {\n      animateScroll(ts, startTime, duration, startPos, distance, scrollEl)\n    })\n  }\n}\n","import './css/chapter.css'\nimport chapterTemplate from './templates/Chapter'\nimport { createElement, secondToTime, marquee, toggleAttribute, animateScroll } from './utils'\n\nlet resize\n\nclass Chapter {\n  constructor(ctx) {\n    this.ctx = ctx\n    this.list = []\n    this.initEvents()\n    this.current = null\n    this._currentSrc = null\n    this._chapterPatched = false\n  }\n\n  init() {\n    this.patchPlayer()\n    this.ui = new ChapterUI(this.ctx)\n    this.ctx.on('chapterchange', (data) => {\n      const id = data && data.newVal ? data.newVal.id : null\n      this.ui.setChapterActive(id)\n    })\n  }\n\n  initEvents() {\n    this.ctx.on('audioupdate',(audio) => {\n      if (!this._chapterPatched) {\n        this.init()\n        this._chapterPatched = true\n      }\n      this.updateList(audio)\n    })\n\n    this.ctx.on('audioparse', (audio) => {\n      this.updateList(audio)\n    })\n    this.ctx.on('timeupdate', this.onTimeupdate.bind(this))\n  }\n\n  clearList() {\n    this.ui.chapterList.innerHTML = ''\n    this.list = []\n    this.current = null\n  }\n\n  updateList(audio) {\n    if (this.list.length) {\n      this.clearList()\n    }\n    if (audio.chapters.length) {\n      this.list = this.handleChapters(audio)\n      this.ui.renderChapterList(this.ctx.chapters)\n      this.clickChapterHandler()\n    }\n    this.ui.handleChapterPanel(this.ctx, audio)\n  }\n\n  handleChapters(audio) {\n    if (audio.chapters && audio.chapters.length) {\n      return audio.chapters.map((chap, i) => {\n        if (!/^ch\\d+$/.test(chap.id)) {\n          chap.id = `ch${i}`\n        }\n      return chap\n      })\n    }\n  }\n\n  patchPlayer() {\n    const self = this\n    Object.defineProperties(this.ctx, {\n      chapters: {\n        get() {\n          return self.list\n        },\n      },\n      currentChapter: {\n        get() {\n          return self.current\n        },\n      },\n    })\n    this.ctx.events.playerEvents.push('chapterchange')\n    this.ctx.updateChapter = updateChapter.bind(self)\n\n    function updateChapter(index) {\n      this.setCurrent(this.list[index])\n      this.ctx.seek(this.current.startTime)\n      this.ctx.play()\n    }\n  }\n\n  setCurrent(chapter) {\n    const _oldCurrentChapter = this.current ? { ...this.current } : null\n    this.current = chapter\n    this.ctx.events.trigger('chapterchange', {\n      newVal: this.current,\n      oldVal: _oldCurrentChapter,\n    })\n  }\n\n  onTimeupdate(e) {\n\n    // ignore handling when audio src changes\n    if (this._currentSrc !== e.currentTarget.src) {\n      this._currentSrc = e.currentTarget.src\n      return\n    }\n    const direction = this.searchDirection(this.ctx.currentTime, this.current)\n    if (direction) {\n      let searchPool\n      const index = this.list.indexOf(this.current)\n      if (index === -1) {\n        searchPool = this.list\n      } else {\n        searchPool = direction === 1 ?\n          this.list.slice(index) :\n          this.list.slice(0, index + 1)\n      }\n      const currentChapter = searchPool.find(ch => {\n        return !this.searchDirection(this.ctx.currentTime, ch)\n      })\n      this.setCurrent(currentChapter)\n    }\n  }\n\n  searchDirection(time, chapter) {\n    time = Math.round(time)\n    if (!chapter ||\n      typeof chapter !== 'object' ||\n      chapter.endTime <= time) {\n      return 1\n    }\n    if (chapter.startTime > time) {\n      return -1\n    }\n    return 0\n  }\n\n  clickChapterHandler() {\n    Array.from(this.ui.chapterList.children).forEach(chEl => {\n      chEl.addEventListener('click', () => {\n        if (!this.ctx.seekable) return\n        let id = chEl.getAttribute('data-id').match(/\\d+$/)\n        if (id) {\n          this.ctx.updateChapter(+id[0])\n        }\n      })\n    })\n  }\n\n  destroy() {\n    this.ui.destroy()\n  }\n}\n\nclass ChapterUI {\n  constructor(player, audio) {\n    this.initEl(player)\n    this.initEvents(player, audio)\n    this.renderChapterList(player.chapters)\n    player.ui.el.append(this.el)\n    this.activeChapterEl = null\n  }\n\n  initEl(player) {\n    this.el = createElement({\n      className: 'shk-chapter',\n      innerHTML: chapterTemplate,\n    })\n    const attrs = {\n      title: 'view chapters',\n      'aria-label': 'view chapters',\n    }\n    if (!player.seekable) {\n      attrs.disabled = ''\n    }\n    this.chapterBtn = createElement({\n      tag: 'button',\n      className: ['shk-btn', 'shk-btn_chapter'],\n      attrs,\n      innerHTML: /* html */`\n        <svg aria-hidden=\"true\">\n          <use xlink:href=\"#shk-icon_chapter\" />\n        </svg>\n      `,\n    })\n    player.ui.seekControls.push(this.chapterBtn)\n    player.ui.extraControls.append(this.chapterBtn)\n    this.closeBtn = this.el.querySelector('.shk-btn_close')\n    this.chapterList = this.el.querySelector('.shk-chapter_list')\n    this.overflowLayer = this.el.querySelector('.shk-chapter_main')\n  }\n\n  initEvents(player) {\n    this.chapterBtn.addEventListener('click', () => {\n      toggleAttribute(player.el, 'data-show-chapter')\n    })\n    player.ui.hideExtraControl(this.chapterBtn)\n    this.closeBtn.addEventListener('click', () => {\n      player.el.removeAttribute('data-show-chapter')\n    })\n\n    // this.handleChapterPanel(player, audio)\n    resize = () => {\n      if (!this.activeChapterEl) return\n      const textWrap = this.activeChapterEl.querySelector('.shk-chapter_title_wrap')\n      const text = this.activeChapterEl.querySelector('.shk-chapter_title')\n      marquee.call(this, textWrap, text)\n    }\n    window.addEventListener('resize', resize)\n  }\n\n  handleChapterPanel(player, audio) {\n    if (audio.chapters.length) {\n      player.el.setAttribute('data-has-chapter', '')\n    } else {\n      player.el.removeAttribute('data-has-chapter')\n    }\n    if (!audio.chapters.length || !player.seekable) {\n      player.el.removeAttribute('data-show-chapter')\n    }\n  }\n\n  renderChapterList(chapters) {\n    if (!chapters.length) return\n    chapters.forEach(ch => {\n      const chapterItemEl = this.renderChapterItem(ch)\n      this.chapterList.append(chapterItemEl)\n    })\n  }\n\n  renderChapterItem(chapter) {\n    const startTime = secondToTime(chapter.startTime)\n    const innerHTML = /* html */`\n      <button class=\"shk-btn shk-chapter_btn\" title=\"seek chapter: ${chapter.title}\" aria-label=\"seek chapter: ${chapter.title}\">\n        <div class=\"shk-icon_chapter\" aria-hidden=\"true\">\n          <span class=\"shk-icon_playing\"></span>\n          <span class=\"shk-icon_triangle\">\n            <svg>\n              <use xlink:href=\"#shk-icon_triangle\" />\n            </svg>\n          </span>\n        </div>\n        <div class=\"shk-chapter_duration\">${startTime}</div>\n        <div class=\"shk-chapter_title_wrap\">\n          <div class=\"shk-chapter_title_inner\" data-chapter=\"${chapter.title}\">\n            <div class=\"shk-chapter_title\">${chapter.title}</div>\n          </div>\n        </div>\n      </button>\n    `\n    return createElement({\n      tag: 'li',\n      className: 'shk-chapter_item',\n      innerHTML: innerHTML,\n      attrs: { 'data-id': chapter.id },\n    })\n  }\n\n  setChapterActive(id) {\n    this.chapterList.querySelectorAll('.shk-chapter_item')\n      .forEach(chEl => {\n        if (chEl.getAttribute('data-id') === id) {\n          chEl.setAttribute('data-active', '')\n          this.scrollIntoView(chEl)\n          this.activeChapterEl = chEl\n          const titleEl = chEl.querySelector('.shk-chapter_title')\n          const titleWrap = chEl.querySelector('.shk-chapter_title_wrap')\n          marquee(titleWrap, titleEl)\n        } else {\n          chEl.removeAttribute('data-active')\n        }\n      })\n  }\n\n  scrollIntoView(el) {\n    if (this.el.style.visibility === 'hidden') return\n    const layerMargin = window.getComputedStyle(this.overflowLayer).marginTop\n    const listMargin = window.getComputedStyle(this.chapterList).marginTop\n    const offsetTop = parseInt(layerMargin) + parseInt(listMargin)\n    const outOfView = (this.overflowLayer.scrollTop + offsetTop - el.offsetTop > 0) || (el.offsetTop - this.overflowLayer.scrollTop - this.overflowLayer.offsetHeight > 0)\n    const startPos = this.overflowLayer.scrollTop\n    const distance = el.offsetTop - startPos - offsetTop\n    const startTime = performance.now()\n    const duration = 0.2\n    if (outOfView) {\n      animateScroll(\n        startTime,\n        startTime,\n        duration,\n        startPos,\n        distance,\n        this.overflowLayer\n      )\n    }\n  }\n\n  destroy() {\n    window.removeEventListener('resize', resize)\n  }\n}\n\nChapter._name = 'chapter'\n\nexport default Chapter\n\n"],"names":["chapterTemplate","secondToTime","time","Math","round","hour","floor","min","sec","marquee","textWrap","textEl","speed","overflow","offsetWidth","setAttribute","duration","style","animationDuration","removeAttribute","createElement","options","tag","el","document","className","classList","add","forEach","attrs","Object","keys","key","innerHTML","toggleAttribute","name","hasAttribute","animateScroll","timestamp","startTime","startPos","distance","scrollEl","elapsed","t","scrollTop","window","requestAnimationFrame","ts","resize","Chapter","constructor","ctx","list","initEvents","current","_currentSrc","_chapterPatched","init","patchPlayer","ui","ChapterUI","on","data","id","newVal","setChapterActive","audio","updateList","onTimeupdate","bind","clearList","chapterList","length","chapters","handleChapters","renderChapterList","clickChapterHandler","handleChapterPanel","map","chap","i","test","self","defineProperties","get","currentChapter","events","playerEvents","push","updateChapter","index","setCurrent","seek","play","chapter","_oldCurrentChapter","trigger","oldVal","e","currentTarget","src","direction","searchDirection","currentTime","searchPool","indexOf","slice","find","ch","endTime","Array","from","children","chEl","addEventListener","seekable","getAttribute","match","destroy","player","initEl","append","activeChapterEl","title","disabled","chapterBtn","seekControls","extraControls","closeBtn","querySelector","overflowLayer","hideExtraControl","text","call","chapterItemEl","renderChapterItem","querySelectorAll","scrollIntoView","titleEl","titleWrap","visibility","layerMargin","getComputedStyle","marginTop","listMargin","offsetTop","parseInt","outOfView","offsetHeight","performance","now","removeEventListener","_name"],"mappings":"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"}